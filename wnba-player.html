<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WNBA Player Prop Helper</title>
  <style>
    body { background: #15151a; color: #f0f0f8; font-family: sans-serif; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #24243a; padding: 24px; border-radius: 12px; }
    h1 { margin-top: 0; }
    label { display: block; margin: 16px 0 6px; }
    input, select, textarea {
      width: 100%; background: #232332; color: #f0f0f8; border: 1px solid #555; padding: 8px; border-radius: 4px;
    }
    button { margin-top: 20px; background: #743ad5; color: #fff; border: none; padding: 10px 16px; border-radius: 5px; cursor: pointer; }
    button:hover { background: #5a2dc7; }
    #results .game-block { background: #33334b; margin: 16px 0; border-radius: 8px; padding: 12px; }
    .team-title { font-weight: bold; margin-bottom: 6px; }
    .player-list { list-style: none; padding-left: 0; }
    .player-list li { margin-bottom: 2px; }
    .no-player { color: #f88; }
    #error { color: #ff605c; margin-top: 12px; min-height: 24px; }
    #loadingIndicator { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WNBA Player Prop Helper</h1>
    <label for="propStat">Stat</label>
    <select id="propStat">
      <option value="PTS">Points</option>
      <option value="AST">Assists</option>
      <option value="TRB">Rebounds</option>
      <option value="3P">3PM</option>
    </select>

    <label for="propValue">Minimum Stat Value</label>
    <input type="number" id="propValue" value="12" min="0" step="1">

    <label for="scheduleDate">Schedule Date</label>
    <input type="date" id="scheduleDate">

    <button id="loadScheduleButton" type="button">Load Schedule</button>
    <span id="loadingIndicator">Loading…</span>

    <label for="schedule">Schedule (paste or auto-load)</label>
    <textarea id="schedule" rows="3" placeholder="e.g. Sparks v. Liberty"></textarea>

    <button id="goBtn" type="button">Show Favorable Players</button>

    <div id="error"></div>
    <div id="results"></div>
  </div>
  <script>
    // --- TEAM NAME MAPPING ---
    // Map from schedule name to player CSV abbreviation
    const teamNameToAbbr = {
      "Aces": "LVA",
      "Dream": "ATL",
      "Fever": "IND",
      "Liberty": "NYL",
      "Lynx": "MIN",
      "Mercury": "PHO",
      "Sky": "CHI",
      "Sparks": "LAS",
      "Storm": "SEA",
      "Sun": "CON",
      "Wings": "DAL",
      "Mystics": "WAS"
    };

    // --- DATA URLS ---
    const PLAYER_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_-6UY7sL7jnnuMH1kmH3AqI5w5GcWtfYstY1PaQkpQP03i0T-Ogl7jBQv8OatEeUXduxQ3ThsYay7/pub?output=csv";
    const SCHEDULE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vROx4fkNFd-O74kZAlxX4L6cZT9Q8In931Wdwv_IkfkV_5AO2sOTrwlQlOFJZYkhu3fxB0QFygwI4_j/pub?output=csv";

    let wnbaPlayersByTeam = {}; // { "LAS": [playerObj, ...], ... }
    let playerCSVLoaded = false;

    // --- PLAYER CSV PARSER ---
    function parsePlayerCSV(text) {
      const rows = text.trim().split('\n');
      const headers = rows[0].split('\t').map(h => h.trim());
      const data = {};
      for (let i = 1; i < rows.length; ++i) {
        const cols = rows[i].split('\t').map(cell => cell.trim());
        const obj = {};
        headers.forEach((h, idx) => obj[h] = cols[idx] || "");
        ['PTS','AST','TRB','3P'].forEach(stat => obj[stat]=parseFloat(obj[stat])||0);
        const team = obj.Team;
        if (!team) return;
        if (!data[team]) data[team] = [];
        data[team].push(obj);
      }
      return data;
    }

    // --- LOAD PLAYER DATA ---
    async function loadPlayers() {
      try {
        const resp = await fetch(PLAYER_CSV_URL);
        if (!resp.ok) throw new Error(resp.statusText);
        const csv = await resp.text();
        wnbaPlayersByTeam = parsePlayerCSV(csv);
        playerCSVLoaded = true;
      } catch (e) {
        document.getElementById('error').textContent = "Failed to load player data. Try refreshing.";
      }
    }

    // --- SCHEDULE PARSER ---
    function parseSchedule(text) {
      const games = [];
      text.split('\n').forEach(line => {
        let m = line.match(/(.+?)\s+v[\.s]*\s+(.+)/i);
        if (m && m[1] && m[2]) {
          games.push([m[1].trim(), m[2].trim()]);
        }
      });
      return games;
    }

    // --- TEAM RESOLVER ---
    function resolveTeam(name) {
      // Try abbreviation mapping first
      const abbr = teamNameToAbbr[name.trim()];
      if (abbr && wnbaPlayersByTeam[abbr]) return abbr;
      // Fallback: check direct match or partial (legacy compatibility)
      name = name.toLowerCase();
      for (const team in wnbaPlayersByTeam) {
        if (team.toLowerCase() === name) return team;
        if (team.toLowerCase().includes(name)) return team;
      }
      return null;
    }

    // --- MAIN LOGIC ---
    function showFavorablePlayers() {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = "";
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = "";

      if (!playerCSVLoaded) {
        errorDiv.textContent = "Player stats are still loading...";
        return;
      }

      const schedule = parseSchedule(document.getElementById('schedule').value);
      if (!schedule.length) {
        errorDiv.textContent = "Please paste your schedule in the correct format.";
        return;
      }

      const propStat = document.getElementById('propStat').value;
      const propStatLabel = document.getElementById('propStat').options[document.getElementById('propStat').selectedIndex].text;
      const propValue = parseFloat(document.getElementById('propValue').value) || 0;

      schedule.forEach(([teamA, teamB]) => {
        [teamA, teamB].forEach(teamName => {
          const resolvedTeam = resolveTeam(teamName);
          let html = `<div class="game-block"><div class="team-title">${teamName}</div>`;
          if (resolvedTeam && wnbaPlayersByTeam[resolvedTeam]) {
            const favorable = wnbaPlayersByTeam[resolvedTeam]
              .filter(p => p[propStat] >= propValue)
              .sort((a,b)=>b[propStat]-a[propStat]);
            if (favorable.length) {
              html += `<ul class="player-list">` + favorable.map(
                p => `<li><b>${p.Player}</b> — ${p[propStat]} ${propStatLabel}</li>`
              ).join('') + `</ul>`;
            } else {
              html += `<div class="no-player">No players average ${propValue}+ ${propStatLabel}.</div>`;
            }
          } else {
            html += `<div class="no-player">Team not found in player database.</div>`;
          }
          html += `</div>`;
          resultsDiv.innerHTML += html;
        });
      });
    }

    // --- SCHEDULE CSV (DATE) LOGIC ---
    function setDefaultScheduleDate() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      document.getElementById('scheduleDate').value = `${yyyy}-${mm}-${dd}`;
    }

    function parseCsvDate(csvDateStr) {
      // Accepts "Wed, Jul 3, 2024" or "Jul 3, 2024"
      const d = new Date(csvDateStr.replace(/^\w+, /, ''));
      if (isNaN(d)) return null;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    async function loadScheduleForDate() {
      const selectedDate = document.getElementById('scheduleDate').value;
      const errorDiv = document.getElementById('error');
      const loadingIndicator = document.getElementById('loadingIndicator');
      if (!selectedDate) {
        errorDiv.textContent = "Please select a date.";
        return;
      }
      errorDiv.textContent = "";
      loadingIndicator.style.display = "inline";
      try {
        const resp = await fetch(SCHEDULE_CSV_URL);
        if (!resp.ok) throw new Error("Failed to fetch schedule CSV");
        const csvText = await resp.text();
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        function normalize(str) {
          return str.trim().replace(/\s+/g, ' ').toLowerCase();
        }
        const normalizedHeaders = headers.map(normalize);
        const dateIdx = normalizedHeaders.indexOf(normalize("Date"));
        const visitorIdx = normalizedHeaders.indexOf(normalize("Visitor/Neutral"));
        const homeIdx = normalizedHeaders.indexOf(normalize("Home/Neutral"));
        if (dateIdx === -1 || visitorIdx === -1 || homeIdx === -1)
          throw new Error("Unexpected CSV format for schedule. Headers: " + headers.join('|'));
        const gamesForDate = [];
        for (let i = 1; i < lines.length; i++) {
          let row = [];
          let match = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
          if (match) row = match.map(s => s.replace(/^"|"$/g, '').trim());
          else row = lines[i].split(',').map(cell => cell.trim());
          const csvDate = parseCsvDate(row[dateIdx]);
          if (csvDate === selectedDate) {
            const away = row[visitorIdx];
            const home = row[homeIdx];
            gamesForDate.push(`${away} v. ${home}`);
          }
        }
        if (gamesForDate.length === 0) {
          errorDiv.textContent = "No games scheduled for that date.";
        } else {
          document.getElementById('schedule').value = gamesForDate.join('\n');
        }
      } catch (err) {
        errorDiv.textContent = "Error loading schedule: " + err.message;
      } finally {
        loadingIndicator.style.display = "none";
      }
    }

    document.getElementById('goBtn').onclick = showFavorablePlayers;
    document.getElementById('loadScheduleButton').onclick = loadScheduleForDate;
    window.onload = function() {
      loadPlayers();
      setDefaultScheduleDate();
    };
  </script>
</body>
</html>
